name: Update Multi Rules
on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 */12 * * *'  # 与basic工作流保持相同调度频率
  push:
    branches: [ "multi" ]  # 仅在multi分支推送时触发
    paths:
      - 'data/python/**'   # 监测python脚本变更
      - 'data/mod/**'      # 监测mod配置变更

permissions:
  contents: write        # 用于代码提交推送
  actions: write         # 用于删除旧工作流记录和工件

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      DATA_DIR: ${{ github.workspace }}/data
      PYTHON_SCRIPTS: ${{ github.workspace }}/data/python
      MIHOMO_BIN: ${{ github.workspace }}/data/mihomo-tool
      MAIN_BRANCH: multi  # 关联multi分支
      TEMP_DIR: 'tmp'     # 添加临时目录环境变量

    steps:
      # 1. 拉取代码（multi分支）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.MAIN_BRANCH }}

      # 2. 清理工作区临时文件（提前执行）
      - name: Cleanup temporary folders (Pre-build)
        run: |
          find "${{ github.workspace }}" -maxdepth 1 \( -name "tmp*" -o -name "temp*" -o -name ".tmp*" -o -name ".temp*" \) -exec rm -rf {} + 2>/dev/null || true
          find "${{ github.workspace }}" -maxdepth 1 \( -name "*.txt" -o -name "*.mrs" -o -name "*.conf" -o -name "*.yaml" \) -exec rm -f {} + 2>/dev/null || true

      # 3. 检测文件变更
      - name: Detect changed files
        id: changes
        uses: tj-actions/changed-files@v42
        with:
          files: |
            data/python/**
            data/mod/**

      # 4. 设置Python环境（仅在需要时执行）
      - name: Set up Python
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 5. 安装依赖（仅手动/定时执行时运行）
      - name: Install dependencies
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq moreutils
          pip install --upgrade pip
          pip install requests aiodns pyyaml beautifulsoup4 pytz chardet aiohttp psutil tldextract

      # 6. 更新Mihomo（仅手动/定时执行时运行）
      - name: Update Mihomo
        id: mihomo
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          LATEST_VERSION=$(curl -sL https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.tag_name' | sed 's/v//')
          echo "Latest version: $LATEST_VERSION"
          
          if [ -f "${{ env.MIHOMO_BIN }}" ]; then
            CURRENT_VERSION=$("${{ env.MIHOMO_BIN }}" -v 2>/dev/null | awk '{print $2}' | sed 's/v//' || echo "0.0.0")
          else
            CURRENT_VERSION="0.0.0"
          fi
          echo "Current version: $CURRENT_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "Updating Mihomo from v$CURRENT_VERSION to v$LATEST_VERSION"
            mkdir -p $(dirname "${{ env.MIHOMO_BIN }}")
            curl -sL "https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64-v${LATEST_VERSION}.gz" | gzip -d > "${{ env.MIHOMO_BIN }}"
            chmod +x "${{ env.MIHOMO_BIN }}"
            echo "mihomo_updated=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Mihomo is up-to-date (v$LATEST_VERSION)"
            echo "mihomo_updated=false" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "$LATEST_VERSION" > "${{ env.DATA_DIR }}/.mihomo_version"

      # 7. 处理基础规则（仅手动/定时执行时运行）
      - name: Process base rules
        id: process_base_rules
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          cd ${{ github.workspace }}
          python ${{ env.PYTHON_SCRIPTS }}/dl.py
          python ${{ env.PYTHON_SCRIPTS }}/merge.py

      # 8. 运行广告拦截规则清理（仅手动/定时执行时运行）
      - name: Run adblock cleaner
        id: adblock_cleaner
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          cd ${{ github.workspace }}
          python ${{ env.PYTHON_SCRIPTS }}/filter_cleaner.py

      # 9. 生成多格式规则（仅手动/定时执行且广告拦截规则清理完成后运行）
      - name: Generate multi-format rules
        if: steps.adblock_cleaner.success() && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
        run: |
          cd ${{ github.workspace }}
          python ${{ env.PYTHON_SCRIPTS }}/filter_adp.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_pihole.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_hosts.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_ubo.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_adg.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_adh.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_clash.py
          python ${{ env.PYTHON_SCRIPTS }}/filter_mihomo.py

      # 10. 更新文档（仅手动/定时执行且多格式规则生成完成后运行）
      - name: Update documentation
        if: steps.generate_multi_format.success() && (github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
        run: |
          cd ${{ github.workspace }}
          python ${{ env.PYTHON_SCRIPTS }}/title.py

      # 11. 提交变更（仅在检测到变更时运行）
      - name: Commit changes
        id: commit
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          cd ${{ github.workspace }}
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          git add --all
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            if [ "${{ steps.mihomo.outputs.mihomo_updated }}" = "true" ]; then
              git commit -m "Multi-format update: Rules + Mihomo v${{ steps.mihomo.outputs.latest_version }} [$(date +'%Y-%m-%d %H:%M:%S') UTC+8]"
            else
              git commit -m "Multi-format update: Rules [$(date +'%Y-%m-%d %H:%M:%S') UTC+8]"
            fi
          fi

      # 12. 推送变更（仅在检测到变更且提交成功时运行）
      - name: Push changes
        if: steps.commit.outputs.has_changes == 'true'
        run: |
          cd ${{ github.workspace }}
          for i in 1 2 3; do
            git pull --rebase origin ${{ env.MAIN_BRANCH }}
            git push origin ${{ env.MAIN_BRANCH }} && break || sleep 5
          done

      # 13. 清理旧工作流（始终运行）
      - name: Cleanup old workflows
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 5

      # 14. 清理构建过程中产生的临时文件（始终运行）
      - name: Cleanup temporary folders (Post-build)
        if: always()
        run: |
          rm -rf "${{ github.workspace }}/tmp*" "${{ github.workspace }}/temp*" "${{ github.workspace }}/.tmp*" "${{ github.workspace }}/.temp*" 2>/dev/null || true

      # 15. 清理旧工件（始终运行）
      - name: Cleanup old artifacts
        if: always()
        uses: c-hive/gha-remove-artifacts@v1.4.0
        with:
          age: '7 days'